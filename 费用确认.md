# 费用确认页面需求文档

## 1. 页面概述

本页面作为用户在选定充电枪后、发起充电前的核心操作页面。用户在此确认充电价格、选择支付方式，并最终启动充电流程。页面需处理个人用户预付费和企业用户钱包支付两种核心场景。

- **页面标题**: 费用确认
- **核心功能**: 价格展示、支付方式选择、发起充电/支付

---

## 2. 页面UI元素与布局

页面从上到下依次布局以下元素：

### 2.1. 顶部站点信息
- **站点名称**: 页面顶部居中或居左显示当前充电站的名称。
- **充电枪信息**:
    - 使用SVG绘制一个充电枪图标。
    - 图标右侧或下方文字显示：“充电枪: X号” (X为动态传入的枪号)。

### 2.2. 充电价格卡片
- 使用一个独立的卡片组件进行展示。
- **主显价格**: `XX.XX 元/度` (价格为动态数据)。
- **辅助信息**: 在价格下方用小号字体显示当前价格对应的时段, 例如 "高峰时段: 08:00-22:00"。

### 2.3. 企业钱包卡片 (条件渲染)
- **显示逻辑**: **仅针对企业用户显示**。需要调用后端接口查询用户关联的企业钱包信息。如果接口无有效数据返回（例如为空或特定状态码），则此卡片区域**整体隐藏**。
- **卡片内容**:
    - **标题**: 企业卡
    - **余额**: 显示 "余额: ¥XX.XX"。
    - **授信金额**: 显示 "授信金额: ¥XX.XX"。

### 2.4. 付款方式选择卡片
- **卡片标题**: 选择付款方式
- **选项**:
    1. **企业卡 (条件渲染)**:
        - **显示逻辑**: 当 `2.3 企业钱包卡片` 显示时，此选项才出现。
        - **关联操作**: 选中后，下方出现 "充电至" 选项，使用**进度条(Slider)组件**让用户设置充电停止的电池百分比（例如从当前电量到100%）。
    2. **预付费**:
        - **默认选中**: 如果企业卡选项不可用，则默认选中此项。
        - **关联操作**: 选中后，下方出现预设金额和自定义金额选项。
        - **预设金额**: 提供 `50元`, `100元`, `300元`, `500元` 四个快捷选择按钮。
        - **自定义金额**: 提供一个输入框，允许用户输入自定义金额。
            - **校验规则**: 自定义金额必须大于等于10元。当用户输入时进行提示或在提交时校验。

### 2.5. 底部悬浮按钮
- **样式**: 按钮固定悬浮在页面最底部，不随页面滚动。
- **按钮文字**: "立即充电"
- **交互逻辑**: 点击按钮时，根据当前选择的付款方式执行不同操作（详见 3.4）。

---

## 3. 核心业务逻辑

### 3.1. 数据获取
- 页面加载时（`onLoad`）, 需要从上一个页面接收 `stationId` 和 `gunId` 参数。
- 调用后端接口，获取以下信息并填充到UI:
    - 充电站名称。
    - 充电枪号。
    - 当前时间段的充电单价。
- **并行调用**后端接口，检查当前用户是否有关联的企业钱包，用于决定是否渲染 `2.3` 和 `2.4` 中的企业卡相关UI。

### 3.2. 用户交互逻辑
- **选择付款方式**:
    - 用户在 "企业卡" 和 "预付费" 之间切换时，下方关联的操作区域（充电百分比设置 / 预付金额选择）也随之切换显示/隐藏。
- **选择预付金额**:
    - 点击预设金额按钮，自定义输入框内容更新为对应金额。
    - 在自定义输入框输入时，清除预设金额按钮的选中状态。

### 3.3. "立即充电"按钮逻辑
- **点击前校验**:
    - 如果选择 "预付费"，且为 "自定义金额"，需校验输入值是否 `>= 10`。若不满足，则提示用户，不执行后续操作。
- **点击后操作**:
    - **若选择 "企业卡"**:
        - 收集参数：`gunId`, `chargePercentage` (充电百分比)。
        - 调用后端**发起充电请求**的接口。
        - 成功后，跳转至 "正在充电" 页面。
    - **若选择 "预付费"**:
        - 收集参数：`gunId`, `amount` (预付金额)。
        - 调用后端**发起支付请求**的接口，获取支付参数。
        - 使用 `uni.requestPayment` 等API调起微信支付/支付宝支付。
        - 支付成功后，后端应有回调机制来启动充电，前端在收到成功回调或轮询确认后，跳转至 "正在充电" 页面。

---

## 4. 后端接口依赖

### 4.1. 获取充电价格与站点信息
- **Endpoint**: `GET /charging/port/info`
- **描述**: 根据充电枪ID获取其所在的站点名称、枪号以及当前时段的价格信息。
- **入参 (Query Parameters)**:
    - `gunId` (String): 充电枪唯一标识。
- **出参 (Response Body)**:
    ```json
    {
        "stationName": "XX中心充电站",
        "gunNo": "A07",
        "price": 1.25,
        "pricePeriod": "高峰时段: 08:00-22:00"
    }
    ```

### 4.2. 获取用户企业钱包信息
- **Endpoint**: `GET /api/user/enterprise/wallet`
- **描述**: 获取当前登录用户的企业钱包信息。后端通过Token自动解析用户身份。
- **入参**: 无。
- **出参 (Response Body)**:
    - **成功 (用户为企业用户)**:
        ```json
        {
            "balance": 588.00,
            "creditAmount": 10000.00
        }
        ```
    - **失败 (用户非企业用户或无钱包)**: 返回 `null` 或空对象 `{}`。

### 4.3. 发起充电 (企业用户)
- **Endpoint**: `POST /api/charge/start/enterprise`
- **描述**: 使用企业钱包发起充电请求。
- **入参 (Request Body)**:
    ```json
    {
        "gunId": "...",
        "chargeToPercent": 90
    }
    ```
- **出参 (Response Body)**:
    ```json
    {
        "orderId": "...",
        "status": "CHARGING"
    }
    ```

### 4.4. 创建预付费订单
- **Endpoint**: `POST /api/charge/prepay`
- **描述**: 为个人用户创建预付费订单，并返回调起支付所需的前端支付参数。
- **入参 (Request Body)**:
    ```json
    {
        "gunId": "...",
        "amount": 50.00
    }
    ```
- **出参 (Response Body)**:
    ```json
    {
        "orderId": "...",
        "paymentParams": {
            "nonceStr": "...",
            "package": "...",
            "paySign": "...",
            "timeStamp": "...",
            "signType": "MD5"
        }
    }
    ```

